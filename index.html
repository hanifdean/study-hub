<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Hub ‚Äî Hanif & Sasya</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

  :root {
    --bg: #0f0f14;
    --surface: #1a1a24;
    --surface-hover: #1e1e2a;
    --border: #2a2a35;
    --text: #e8e4de;
    --text-muted: #8a8578;
    --accent: #5ec4b6;
    --accent-glow: rgba(94, 196, 182, 0.12);
    --tag-bg: #1a2f2d;
    --tag-text: #5ec4b6;
    --card-shadow: 0 2px 12px rgba(0,0,0,0.3);
    --divider: #22222e;
    --search-bg: #14141c;
    --star-color: #f59e0b;
    --fav-bg: rgba(245, 158, 11, 0.06);
    --fav-border: rgba(245, 158, 11, 0.25);
  }

  [data-theme="light"] {
    --bg: #f8f6f2;
    --surface: #ffffff;
    --surface-hover: #faf8f5;
    --border: #e5e0d8;
    --text: #2c2a26;
    --text-muted: #7a7570;
    --accent: #1a8a7d;
    --accent-glow: rgba(26, 138, 125, 0.06);
    --tag-bg: #e6f3f1;
    --tag-text: #15756a;
    --card-shadow: 0 2px 12px rgba(0,0,0,0.06);
    --divider: #e5e0d8;
    --search-bg: #f0ede8;
    --star-color: #d97706;
    --fav-bg: rgba(217, 119, 6, 0.04);
    --fav-border: rgba(217, 119, 6, 0.2);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    transition: background 0.3s ease, color 0.3s ease;
  }

  .container {
    max-width: 720px;
    margin: 0 auto;
    padding: 2.5rem 1.25rem 4rem;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
  }
  .header-left h1 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 0.25rem;
  }
  .header-left p {
    font-size: 0.85rem;
    color: var(--text-muted);
  }
  #page-count { font-weight: 600; }

  /* Theme toggle */
  .theme-toggle {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    border: 1.5px solid var(--border);
    background: var(--surface);
    color: var(--text-muted);
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  .theme-toggle:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  /* Search */
  .search-wrap {
    position: relative;
    margin-bottom: 1rem;
  }
  .search-wrap input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border-radius: 12px;
    border: 1.5px solid var(--border);
    background: var(--search-bg);
    color: var(--text);
    font-size: 0.9rem;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-wrap input::placeholder { color: var(--text-muted); }
  .search-wrap input:focus { border-color: var(--accent); }
  .search-wrap .search-icon {
    position: absolute;
    left: 0.85rem;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.95rem;
    color: var(--text-muted);
    pointer-events: none;
  }

  /* Controls row */
  .controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  .sort-select {
    padding: 0.4rem 0.7rem;
    border-radius: 8px;
    border: 1.5px solid var(--border);
    background: var(--surface);
    color: var(--text-muted);
    font-size: 0.75rem;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
  }
  .sort-select:focus { border-color: var(--accent); }

  /* Tag filter pills */
  .tag-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    margin-bottom: 1.25rem;
  }
  .tag-pill {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    border-radius: 6px;
    border: 1.5px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    font-size: 0.7rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
    user-select: none;
  }
  .tag-pill:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .tag-pill.active {
    background: var(--tag-bg);
    color: var(--tag-text);
    border-color: var(--accent);
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }
  .tab {
    flex: 1;
    padding: 0.7rem 1rem;
    border-radius: 12px;
    border: 1.5px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.25s ease;
    font-family: inherit;
    text-align: center;
  }
  .tab.active {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
  }
  .tab:hover:not(.active) {
    border-color: var(--accent);
    color: var(--accent);
  }

  /* Favorites section */
  .favorites-section {
    margin-bottom: 1.75rem;
    display: none;
  }
  .favorites-section.visible { display: block; }
  .favorites-section .section-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--star-color);
    margin-bottom: 0.75rem;
    padding-left: 0.25rem;
  }

  /* Course group */
  .course-group {
    margin-bottom: 1.75rem;
  }
  .course-group-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    margin-bottom: 0.75rem;
    padding-left: 0.25rem;
    user-select: none;
  }
  .course-group-header:hover .course-group-title { color: var(--accent); }
  .course-group-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    transition: color 0.2s;
  }
  .group-count {
    font-size: 0.65rem;
    font-weight: 700;
    color: var(--text-muted);
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 0.1rem 0.4rem;
    border-radius: 6px;
  }
  .group-chevron {
    font-size: 0.7rem;
    color: var(--text-muted);
    transition: transform 0.2s;
    margin-left: auto;
  }
  .course-group.collapsed .group-chevron { transform: rotate(-90deg); }
  .course-group.collapsed .group-cards { display: none; }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 14px;
    padding: 1.1rem 1.25rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
    text-decoration: none;
    display: block;
    color: inherit;
    position: relative;
  }
  .card:hover {
    border-color: var(--accent);
    background: var(--surface-hover);
    box-shadow: var(--card-shadow);
    transform: translateY(-1px);
  }
  .card-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.35rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding-right: 2rem;
  }
  .card-title .icon { font-size: 1rem; }
  .card-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 0.6rem;
  }
  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }
  .tag {
    display: inline-block;
    background: var(--tag-bg);
    color: var(--tag-text);
    padding: 0.15rem 0.55rem;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 600;
  }

  /* Star button */
  .star-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    color: var(--text-muted);
    transition: color 0.2s, transform 0.2s;
    padding: 2px;
    line-height: 1;
  }
  .star-btn:hover { transform: scale(1.2); }
  .star-btn.starred { color: var(--star-color); }

  /* Empty state */
  .empty {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-muted);
    font-size: 0.85rem;
  }
  .empty .emoji { font-size: 2rem; margin-bottom: 0.75rem; }

  /* No results */
  .no-results {
    text-align: center;
    padding: 2.5rem 1rem;
    color: var(--text-muted);
    font-size: 0.85rem;
    display: none;
  }

  /* Footer */
  .footer {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--divider);
    text-align: center;
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  @media (max-width: 480px) {
    .container { padding: 1.5rem 1rem 3rem; }
    .header-left h1 { font-size: 1.25rem; }
    .tab { font-size: 0.8rem; padding: 0.6rem 0.75rem; }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="header-left">
      <h1>üìö Study Hub</h1>
      <p><span id="page-count">19</span> pages, curated by Robin üê±</p>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
      <span id="theme-icon">üåô</span>
    </button>
  </div>

  <!-- Search -->
  <div class="search-wrap">
    <span class="search-icon">üîç</span>
    <input type="text" id="search-input" placeholder="What are you looking for? Try 'semiconductors', 'Coupa', 'mind map'..." autocomplete="off">
  </div>

  <!-- Controls: sort -->
  <div class="controls">
    <select class="sort-select" id="sort-select">
      <option value="recent">Recently Added</option>
      <option value="alpha">Alphabetical</option>
      <option value="category">By Category</option>
    </select>
  </div>

  <!-- Tag filters -->
  <div class="tag-filters" id="tag-filters"></div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-section="sasya" onclick="switchTab('sasya', this)">‚ú® Sasya's Materials</button>
    <button class="tab" data-section="hanif" onclick="switchTab('hanif', this)">üíª Hanif's Materials</button>
  </div>

  <!-- Favorites -->
  <div class="favorites-section" id="favorites-section">
    <div class="section-label">‚≠ê Favorites</div>
    <div id="favorites-cards"></div>
  </div>

  <!-- Dynamic content -->
  <div id="content-area"></div>

  <!-- No results -->
  <div class="no-results" id="no-results">
    <div class="emoji">üîç</div>
    <p>No pages match your search or filters.</p>
  </div>

  <div class="footer">
    Built with üê± by Robin ‚Äî updated as new materials are added
  </div>
</div>

<script>
// ============================================================
// DATA
// ============================================================
const PAGES = [
  // --- Sasya ---
  {
    id: 'simon-mindmaps',
    title: 'Simon ‚Äî Mind Maps',
    icon: 'üó∫Ô∏è',
    desc: "Two interactive mind maps of Herbert Simon's \"Understanding the Natural and the Artificial Worlds\" ‚Äî Academic Disciplines & Representing Machines.",
    tags: ['Public Management', 'Mind Map'],
    url: 'public-management/simon-mindmaps.html',
    category: 'Public Management',
    categoryIcon: 'üèõÔ∏è',
    section: 'sasya',
    date: '2025-01-15'
  },
  {
    id: 'coupa-case',
    title: 'Coupa ‚Äî Venture Growth & IPO Strategy',
    icon: 'üí∞',
    desc: 'POC framework, cash flow drivers, sales rep IRR, organic vs aggressive growth, valuation at different scenarios.',
    url: 'finance/coupa-case-study.html',
    tags: ['Finance', 'Case Study'],
    category: 'Entrepreneurial Finance',
    categoryIcon: 'üí∞',
    section: 'sasya',
    date: '2026-02-01'
  },
  {
    id: 'broken-promise',
    title: 'The Broken Promise ‚Äî Companies Staying Private Too Long',
    icon: 'üîí',
    desc: 'Citrini\'s argument: companies staying private breaks the social contract. Neo-feudalism, accredited investor gates, $7.7T in unicorns inaccessible to retail.',
    url: 'finance/broken-promise.html',
    tags: ['Finance', 'Deep Dive', 'Case Study'],
    category: 'Investing & Markets',
    categoryIcon: 'üí∞',
    section: 'hanif',
    date: '2026-02-02'
  },
  {
    id: 'polymarket-arbitrage',
    title: 'The Math Needed for Trading on Polymarket',
    icon: 'üìà',
    desc: 'How sophisticated traders extracted $40M in arbitrage using marginal polytopes, Bregman projections, and Frank-Wolfe optimization.',
    url: 'investing/polymarket-arbitrage.html',
    tags: ['Investing', 'Deep Dive', 'Case Study'],
    category: 'Investing & Markets',
    categoryIcon: 'üí∞',
    section: 'hanif',
    date: '2026-02-02'
  },
  {
    id: 'swiperx-case',
    title: 'SwipeRx ‚Äî Scaling vs Mission in Social Enterprise',
    icon: 'üå±',
    desc: 'Zahra typology, Compartamos comparison, when scaling helps vs hurts mission, Apotek Inofarma expansion analysis.',
    url: 'social-innovation/swiperx-case.html',
    tags: ['Social Innovation', 'Case Study'],
    category: 'Social Innovation & Design',
    categoryIcon: 'üå±',
    section: 'sasya',
    date: '2026-01-31'
  },
  {
    id: 'who-pays-overview',
    title: 'Who Pays? ‚Äî 5 Cases in Social Innovation',
    icon: 'üí∏',
    desc: 'Insulin, Compartamos, OneDay Health, SwipeRx, ImpulsoGov ‚Äî who bears the cost when business models collide with social missions. Zahra typology mapping & cross-case analysis.',
    url: 'social-innovation/who-pays-overview.html',
    tags: ['Social Innovation', 'Case Study', 'Summary'],
    category: 'Social Innovation & Design',
    categoryIcon: 'üå±',
    section: 'sasya',
    date: '2026-02-02'
  },
  {
    id: 'pm-w3-summaries',
    title: 'Week 3 Readings ‚Äî Kroes, Simon & Lawson',
    icon: 'üìñ',
    desc: 'Dual nature of artefacts, science of the artificial, illusion of explanatory depth. How they connect to public management.',
    url: 'public-management/w3-summaries.html',
    tags: ['Public Management', 'Summary'],
    category: 'Public Management',
    categoryIcon: 'üèõÔ∏è',
    section: 'sasya',
    date: '2026-02-01'
  },
  // --- Hanif: AI Value Chain ---
  {
    id: 'layer1',
    title: 'Layer 1: Raw Materials & Equipment',
    icon: '‚õèÔ∏è',
    desc: 'Rare earths, silicon, copper, lithography machines (ASML), and the geopolitical chokepoints at the base of the stack.',
    tags: ['Semiconductors', 'Deep Dive'],
    url: 'ai-value-chain/layer1-raw-materials.html',
    category: 'AI & Semiconductor Value Chain',
    categoryIcon: 'ü§ñ',
    section: 'hanif',
    date: '2025-02-01'
  },
  {
    id: 'layer2',
    title: 'Layer 2: Chip Design',
    icon: 'üß†',
    desc: 'Nvidia, AMD, Broadcom, ARM, Qualcomm ‚Äî GPU architectures, EDA tools, and the fabless model.',
    tags: ['Semiconductors', 'Deep Dive'],
    url: 'ai-value-chain/layer2-chip-design.html',
    category: 'AI & Semiconductor Value Chain',
    categoryIcon: 'ü§ñ',
    section: 'hanif',
    date: '2025-02-02'
  },
  {
    id: 'layer3',
    title: 'Layer 3: Foundries & Fabrication',
    icon: 'üè≠',
    desc: 'TSMC, Samsung, Intel ‚Äî process nodes, fab economics, and why manufacturing is the ultimate bottleneck.',
    tags: ['Semiconductors', 'Deep Dive'],
    url: 'ai-value-chain/layer3-foundries.html',
    category: 'AI & Semiconductor Value Chain',
    categoryIcon: 'ü§ñ',
    section: 'hanif',
    date: '2025-02-03'
  },
  {
    id: 'layer4-hbm',
    title: 'Layer 4: HBM & Memory',
    icon: 'üíæ',
    desc: 'High Bandwidth Memory ‚Äî SK Hynix, Samsung, Micron. Why HBM is the AI bottleneck and production tradeoffs with consumer DRAM.',
    tags: ['Semiconductors', 'Deep Dive'],
    url: 'ai-value-chain/hbm-memory-layer.html',
    category: 'AI & Semiconductor Value Chain',
    categoryIcon: 'ü§ñ',
    section: 'hanif',
    date: '2025-02-04'
  },
  {
    id: 'cowos',
    title: 'CoWoS Advanced Packaging',
    icon: 'üì¶',
    desc: "TSMC's Chip-on-Wafer-on-Substrate ‚Äî the critical step that bonds chips to HBM, and why it's capacity-constrained.",
    tags: ['Semiconductors', 'Deep Dive'],
    url: 'ai-value-chain/cowos-packaging.html',
    category: 'AI & Semiconductor Value Chain',
    categoryIcon: 'ü§ñ',
    section: 'hanif',
    date: '2025-02-05'
  },
  {
    id: 'layer5',
    title: 'Layer 5: Systems, Servers & Networking',
    icon: 'üñß',
    desc: 'Server racks, NVLink, InfiniBand ‚Äî how GPUs connect into clusters and the networking stack that makes AI training possible.',
    tags: ['AI Infrastructure', 'Deep Dive'],
    url: 'ai-value-chain/layer5-systems-networking.html',
    category: 'AI & Semiconductor Value Chain',
    categoryIcon: 'ü§ñ',
    section: 'hanif',
    date: '2025-02-06'
  },
  {
    id: 'layer6',
    title: 'Layer 6: Energy & Data Centers',
    icon: '‚ö°',
    desc: 'Power demands, cooling, nuclear renaissance ‚Äî the physical infrastructure powering the AI revolution.',
    tags: ['AI Infrastructure', 'Deep Dive'],
    url: 'ai-value-chain/layer6-energy-datacenters.html',
    category: 'AI & Semiconductor Value Chain',
    categoryIcon: 'ü§ñ',
    section: 'hanif',
    date: '2025-02-07'
  },
  {
    id: 'layer7',
    title: 'Layer 7: Cloud & Compute Providers',
    icon: '‚òÅÔ∏è',
    desc: 'AWS, Azure, GCP, CoreWeave ‚Äî hyperscalers and GPU cloud economics.',
    tags: ['AI Infrastructure', 'Deep Dive'],
    url: 'ai-value-chain/layer7-cloud-compute.html',
    category: 'AI & Semiconductor Value Chain',
    categoryIcon: 'ü§ñ',
    section: 'hanif',
    date: '2025-02-08'
  },
  {
    id: 'layer8',
    title: 'Layer 8: AI Labs & Software',
    icon: 'ü§ñ',
    desc: 'OpenAI, Anthropic, Google DeepMind, Meta AI ‚Äî the labs building frontier models and the software layer on top.',
    tags: ['AI Infrastructure', 'Deep Dive'],
    url: 'ai-value-chain/layer8-ai-labs.html',
    category: 'AI & Semiconductor Value Chain',
    categoryIcon: 'ü§ñ',
    section: 'hanif',
    date: '2025-02-09'
  },
  {
    id: 'si-photonics',
    title: 'Silicon Photonics',
    icon: 'üí°',
    desc: 'Light-based data transfer on silicon ‚Äî the emerging technology connecting chips at the speed of light.',
    tags: ['Emerging Tech', 'Deep Dive'],
    url: 'ai-value-chain/silicon-photonics.html',
    category: 'AI & Semiconductor Value Chain',
    categoryIcon: 'ü§ñ',
    section: 'hanif',
    date: '2025-02-10'
  },
  {
    id: 'si-photonics-2',
    title: 'Silicon Photonics II: CMOS Leverage',
    icon: 'üî¨',
    desc: 'How old fabs become gold mines ‚Äî materials, lithography, design tools & the economic moat.',
    tags: ['Semiconductors', 'Emerging Tech'],
    url: 'ai-value-chain/silicon-photonics-2.html',
    category: 'AI & Semiconductor Value Chain',
    categoryIcon: 'ü§ñ',
    section: 'hanif',
    date: '2025-02-11'
  },
  // --- Hanif: Investing ---
  {
    id: 'strava-unit-econ',
    title: 'Strava ‚Äî Unit Economics Breakdown',
    icon: 'üèÉ',
    desc: "Deep dive into Strava's business model, subscriber economics, and path to profitability.",
    tags: ['Finance', 'Case Study'],
    url: 'investing/strava-unit-economics.html',
    category: 'Entrepreneurial Finance',
    categoryIcon: 'üí∞',
    section: 'sasya',
    date: '2025-03-01'
  },
  {
    id: 'pain-reflection',
    title: 'Pain + Reflection = Progress',
    icon: 'üî•',
    desc: 'Lessons from a 6-sigma silver crash ‚Äî short gamma mechanics, China premium, and money wisdom from @abcampbell.',
    tags: ['Investing', 'Deep Dive'],
    url: 'investing/pain-reflection-progress.html',
    category: 'Investing & Markets',
    categoryIcon: 'üí∞',
    section: 'hanif',
    date: '2026-02-02'
  }
];

// ============================================================
// STATE
// ============================================================
let currentSection = 'sasya';
let activeTags = new Set();
let favorites = new Set(JSON.parse(localStorage.getItem('studyhub-favs') || '[]'));
let searchQuery = '';
let sortMode = 'recent';

// ============================================================
// FUZZY SEARCH
// ============================================================
function fuzzyMatch(text, query) {
  text = text.toLowerCase();
  query = query.toLowerCase();
  if (text.includes(query)) return true;
  // simple subsequence match
  let qi = 0;
  for (let i = 0; i < text.length && qi < query.length; i++) {
    if (text[i] === query[qi]) qi++;
  }
  return qi === query.length;
}

function matchesSearch(page) {
  if (!searchQuery) return true;
  const q = searchQuery.trim();
  if (!q) return true;
  const haystack = [page.title, page.desc, page.category, ...page.tags].join(' ');
  return fuzzyMatch(haystack, q);
}

function matchesTags(page) {
  if (activeTags.size === 0) return true;
  for (const t of activeTags) {
    if (!page.tags.some(pt => pt.toLowerCase() === t.toLowerCase())) return false;
  }
  return true;
}

// ============================================================
// RENDER
// ============================================================
function getFilteredPages() {
  return PAGES.filter(p =>
    p.section === currentSection &&
    matchesSearch(p) &&
    matchesTags(p)
  );
}

function sortPages(pages) {
  const arr = [...pages];
  switch (sortMode) {
    case 'alpha':
      arr.sort((a, b) => a.title.localeCompare(b.title));
      break;
    case 'category':
      arr.sort((a, b) => a.category.localeCompare(b.category) || a.title.localeCompare(b.title));
      break;
    case 'recent':
    default:
      arr.sort((a, b) => b.date.localeCompare(a.date));
      break;
  }
  return arr;
}

function renderCard(page, isFav) {
  const starred = favorites.has(page.id);
  return `
    <div class="card" style="cursor:pointer;" onclick="if(!event.target.closest('.star-btn'))window.location.href='${page.url}'">
      <button class="star-btn ${starred ? 'starred' : ''}" onclick="event.stopPropagation();toggleFav('${page.id}')" title="${starred ? 'Remove from favorites' : 'Add to favorites'}">
        ${starred ? '‚òÖ' : '‚òÜ'}
      </button>
      <div class="card-title">
        <span class="icon">${page.icon}</span> ${page.title}
      </div>
      <div class="card-desc">${page.desc}</div>
      <div class="tags">${page.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>
    </div>
  `;
}

function render() {
  const filtered = getFilteredPages();
  const sorted = sortPages(filtered);
  const area = document.getElementById('content-area');
  const noResults = document.getElementById('no-results');

  // Favorites for current section
  const favPages = PAGES.filter(p =>
    p.section === currentSection &&
    favorites.has(p.id) &&
    matchesSearch(p) &&
    matchesTags(p)
  );
  const favSection = document.getElementById('favorites-section');
  const favCards = document.getElementById('favorites-cards');
  if (favPages.length > 0) {
    favSection.classList.add('visible');
    favCards.innerHTML = sortPages(favPages).map(p => renderCard(p, true)).join('');
  } else {
    favSection.classList.remove('visible');
    favCards.innerHTML = '';
  }

  if (sorted.length === 0) {
    area.innerHTML = '';
    noResults.style.display = 'block';
    return;
  }
  noResults.style.display = 'none';

  // Group by category
  const groups = new Map();
  for (const p of sorted) {
    if (!groups.has(p.category)) {
      groups.set(p.category, { icon: p.categoryIcon, pages: [] });
    }
    groups.get(p.category).pages.push(p);
  }

  let html = '';
  for (const [cat, data] of groups) {
    const groupId = cat.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
    const collapsed = localStorage.getItem('collapse-' + groupId) === '1';
    html += `
      <div class="course-group ${collapsed ? 'collapsed' : ''}" data-group="${groupId}">
        <div class="course-group-header" onclick="toggleGroup('${groupId}')">
          <span class="course-group-title">${data.icon} ${cat}</span>
          <span class="group-count">${data.pages.length}</span>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="group-cards">
          ${data.pages.map(p => renderCard(p, false)).join('')}
        </div>
      </div>
    `;
  }

  // Add empty categories for Sasya
  if (currentSection === 'sasya') {
    const sasyaCategories = ['Dissertation (MG4J5)'];
    const sasyaIcons = ['üìñ'];
    const existingCats = new Set(groups.keys());
    sasyaCategories.forEach((cat, i) => {
      if (!existingCats.has(cat) && !searchQuery && activeTags.size === 0) {
        html += `
          <div class="course-group">
            <div class="course-group-header">
              <span class="course-group-title">${sasyaIcons[i]} ${cat}</span>
              <span class="group-count">0</span>
            </div>
            <div class="group-cards">
              <div class="empty"><div class="emoji">üìù</div>Materials coming soon</div>
            </div>
          </div>
        `;
      }
    });
  }

  // Add empty categories for Hanif
  if (currentSection === 'hanif') {
    const hanifEmpty = [{ name: 'Cambridge MBA Prep', icon: 'üéì' }];
    const existingCats = new Set(groups.keys());
    hanifEmpty.forEach(cat => {
      if (!existingCats.has(cat.name) && !searchQuery && activeTags.size === 0) {
        html += `
          <div class="course-group">
            <div class="course-group-header">
              <span class="course-group-title">${cat.icon} ${cat.name}</span>
              <span class="group-count">0</span>
            </div>
            <div class="group-cards">
              <div class="empty"><div class="emoji">üìù</div>Materials coming soon</div>
            </div>
          </div>
        `;
      }
    });
  }

  area.innerHTML = html;
}

// ============================================================
// TAG FILTERS
// ============================================================
function buildTagFilters() {
  const allTags = new Set();
  PAGES.forEach(p => p.tags.forEach(t => allTags.add(t)));
  const sorted = [...allTags].sort();
  const container = document.getElementById('tag-filters');
  container.innerHTML = sorted.map(t => {
    const active = activeTags.has(t) ? 'active' : '';
    return `<button class="tag-pill ${active}" onclick="toggleTag('${t.replace(/'/g, "\\'")}')">${t}</button>`;
  }).join('');
}

function toggleTag(tag) {
  if (activeTags.has(tag)) activeTags.delete(tag);
  else activeTags.add(tag);
  buildTagFilters();
  render();
}

// ============================================================
// ACTIONS
// ============================================================
function switchTab(section, btn) {
  currentSection = section;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  render();
}

function toggleGroup(groupId) {
  const el = document.querySelector(`[data-group="${groupId}"]`);
  if (!el) return;
  el.classList.toggle('collapsed');
  localStorage.setItem('collapse-' + groupId, el.classList.contains('collapsed') ? '1' : '0');
}

function toggleFav(pageId) {
  if (favorites.has(pageId)) favorites.delete(pageId);
  else favorites.add(pageId);
  localStorage.setItem('studyhub-favs', JSON.stringify([...favorites]));
  render();
}

function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  document.getElementById('theme-icon').textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', next);
}

// ============================================================
// INIT
// ============================================================
(function() {
  // Restore theme (default to light)
  const saved = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved);
  document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

    // Update page count
    document.getElementById('page-count').textContent = PAGES.length;

    // Search
    document.getElementById('search-input').addEventListener('input', function() {
      searchQuery = this.value;
      render();
    });

    // Sort
    document.getElementById('sort-select').addEventListener('change', function() {
      sortMode = this.value;
      render();
    });

    buildTagFilters();
    render();
  });
})();
</script>

</body>
</html>
